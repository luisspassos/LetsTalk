<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js"
      crossorigin="anonymous"
    ></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, Helvetica, sans-serif;
      }

      body {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 0.625rem;
      }

      .container button {
        height: 3.125rem;
        font-size: 1.25rem;
        font-weight: bold;
      }

      .messageInput {
        min-height: 2.5rem;
        width: 31.25rem;
        font-size: 1.25rem;
        line-height: 1.5rem;
        border: 1px solid white;
        background-color: darkgray;
        padding: 0.78125rem 0.625rem;
      }

      .emojiWrapper {
        height: 100%;
        display: flex;
        align-items: center;
      }

      .emoji {
        height: 1em;
        width: 1em;
        margin: 0 0.05em 0 0.1em;
        vertical-align: -0.1em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div contenteditable id="messageInput" class="messageInput"></div>
      <button id="copyButton">Copy and paste emoji</button>
    </div>

    <script>
      const copyButton = document.getElementById('copyButton');
      const messageInput = document.querySelector('.messageInput');

      const selection = window.getSelection();

      function insertTextAtCursor() {
        const emojiInserted = document.createElement('img');
        emojiInserted.src =
          'https://raw.githubusercontent.com/twitter/twemoji/ad3d3d669bb3697946577247ebb15818f09c6c91/assets/svg/1f415-200d-1f9ba.svg';
        emojiInserted.alt = '🐕‍🦺';
        emojiInserted.classList.add('emoji');

        const focusedElem = document.activeElement;
        const messageInputIsFocused = focusedElem.className === 'messageInput';

        if (!messageInputIsFocused) {
          messageInput.focus();
          messageInput.innerHTML += emojiInserted.outerHTML;

          function putCursorAtTheEnd() {
            selection.selectAllChildren(messageInput);
            selection.collapseToEnd();
          }

          putCursorAtTheEnd();

          return;
        }

        function positionCursor() {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(emojiInserted);
          range.setStartAfter(emojiInserted);

          selection.removeAllRanges();
          selection.addRange(range);
        }

        positionCursor();
      }

      function convertTextFromMessageInputToHtml(text) {
        const convertedText = twemoji.parse(text);

        const convertedTextHtml = document.createElement('span');
        convertedTextHtml.innerHTML = convertedText;

        return convertedTextHtml;
      }

      messageInput.addEventListener('dragstart', (e) => {
        e.preventDefault();
      });

      let continueInputEvent = true;

      let oldMessage = '';

      function getCaretPosition(editableDiv) {
        var caretPos = 0,
          sel,
          range;
        if (window.getSelection) {
          sel = window.getSelection();
          if (sel.rangeCount) {
            range = sel.getRangeAt(0);
            if (range.commonAncestorContainer.parentNode == editableDiv) {
              caretPos = range.endOffset;
            }
          }
        } else if (document.selection && document.selection.createRange) {
          range = document.selection.createRange();
          if (range.parentElement() == editableDiv) {
            var tempEl = document.createElement('span');
            editableDiv.insertBefore(tempEl, editableDiv.firstChild);
            var tempRange = range.duplicate();
            tempRange.moveToElementText(tempEl);
            tempRange.setEndPoint('EndToEnd', range);
            caretPos = tempRange.text.length;
          }
        }
        return caretPos;
      }

      messageInput.addEventListener('beforeinput', (e) => {
        oldMessage = messageInput.innerHTML;
      });

      let cursorPosition = 0;

      messageInput.addEventListener('input', (e) => {
        cursorPosition = getCaretPosition(messageInput);

        if (!continueInputEvent) {
          messageInput.innerHTML = oldMessage;
          var el = document.getElementsByClassName('emoji')[0];

          if (!el) return;

          var range = document.createRange();
          var sel = window.getSelection();
          range.setStartAfter(el);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
          return;
        }

        console.log(cursorPosition);

        const emojis = messageInput.querySelectorAll('img');

        emojis.forEach((img) => {
          messageInput.replaceChild(document.createTextNode(img.alt), img);
        });

        const message = messageInput.textContent;
        const newMessage = twemoji.parse(message);

        messageInput.innerHTML = newMessage;

        var el = document.getElementsByClassName('emoji')[0];
        var range = document.createRange();
        var sel = window.getSelection();
        range.setStartAfter(el);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);

        continueInputEvent = false;

        setTimeout(() => {
          continueInputEvent = true;
        }, 0);
      });

      messageInput.addEventListener('drop', (e) => {
        e.preventDefault();

        const dataTransfer = e.dataTransfer;
        const draggedText = dataTransfer.getData('text');
        const convertedDraggedTextHtml =
          convertTextFromMessageInputToHtml(draggedText);

        let range;

        if (document.caretRangeFromPoint) {
          range = document.caretRangeFromPoint(e.clientX, e.clientY);
        } else {
          const pos = [e.rangeParent, e.rangeOffset];
          range = document.createRange();
          range.setStart(...pos);
          range.setEnd(...pos);
        }

        range.insertNode(convertedDraggedTextHtml);
      });

      messageInput.addEventListener('paste', (e) => {
        e.preventDefault();

        const paste = (e.clipboardData || window.clipboardData).getData('text');

        const convertedPasteHtml = convertTextFromMessageInputToHtml(paste);

        if (!selection.rangeCount) return;

        selection.deleteFromDocument();
        selection.getRangeAt(0).insertNode(convertedPasteHtml);
        selection.collapseToEnd();
      });

      copyButton.addEventListener('mousedown', (e) => {
        e.preventDefault();
      });

      copyButton.addEventListener('click', insertTextAtCursor);
    </script>
  </body>
</html>
